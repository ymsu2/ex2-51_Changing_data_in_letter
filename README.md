# [ex2-51] Изменение данных в письме

## Реализовать установку данных отсылаемых в письме по почтовому событию FEEDBACK_FORM, после заполнения формы, создаваемой компонентом bitrix:main.feedback
- Для проверки работу решения создать раздел сайта /ex2/feedback/, добавить пункт в главное меню «Экзамен2», и пункт в левом меню «Форма обратной связи».
- Создание нового компонента, типа почтового события или почтового шаблона - будет неверным решением, должны использоваться типовые.
- Макрос #AUTHOR# должен получить значение
- Если пользователь не авторизован: «Пользователь не авторизован, данные из формы: Имя пользователя». Где Имя пользователя – значение из соответствующего поля формы
	- Если пользователь авторизован: «Пользователь авторизован: id (логин) имя, данные из формы: Имя пользователя». Где id, логин, имя – данные пользователя в системе, Имя пользователя – значение из соответствующего поля формы
- Почтовый сервер складывает письма в папку /home/bitrix/mail, можно проверить решение.
- Добавлять запись в журнал событий: «Замена данных в отсылаемом письме – [AUTHOR]». Где [AUTHOR] - это данные макроса AUTHOR подставленного в письмо.

## Пошаговая инструкция

1. Создать раздел сайта /ex2/feedback/
1.1 В административной панели Bitrix перейдите в Контент → Структура сайта.
1.2 Создайте раздел /ex2/ → внутри него /ex2/feedback/.
1.3 Создайте файл /ex2/feedback/index.php

2. Добавить пункт в главное меню «Экзамен2» 
2.1 Перейдите в Контент → Меню → Главное меню (top).
2.2 Добавьте пункт:
- Название: Экзамен2
- Ссылка: /ex2/feedback/

3. Добавить пункт в левое меню «Форма обратной связи»
3.1 Перейдите в Контент → Меню → Левое меню (left).
3.2 Добавьте пункт:
- Название: Форма обратной связи
- Ссылка: /ex2/feedback/

4. Настроить почтовый шаблон для события FEEDBACK_FORM 
4.1 Перейдите в Настройки → Настройки продукта → Почтовые события → Типы почтовых событий.
4.2 Найдите тип события FEEDBACK_FORM → нажмите на него.
4.3 Убедитесь, что в описании макросов есть #AUTHOR# (если нет — добавьте вручную в описание, но не обязательно).
4.4 Перейдите в Почтовые шаблоны → выберите шаблон, привязанный к FEEDBACK_FORM (или создайте новый, но не создавайте новый тип события!).
4.5 В теле письма обязательно используйте макрос #AUTHOR#, например:

```
Здравствуйте!

Получено сообщение через форму обратной связи.

Автор: #AUTHOR#

Сообщение: #MESSAGE#

С уважением,
Сайт
``` 

5. Создать обработчик события OnBeforeEventSend 
5.1 Это ключевой шаг — перехват отправки почты и модификация данных. Создайте файл: /bitrix/php_interface/init.php 
5.2 Если его нет — создайте. Если есть — добавьте в него код.

``` 
<?php

AddEventHandler("main", "OnBeforeEventSend", "replaceFeedbackAuthorMacro");

function replaceFeedbackAuthorMacro(&$event, &$lid, &$arFields)
{
    // Обрабатываем только событие FEEDBACK_FORM
    if ($event != "FEEDBACK_FORM") {
        return;
    }

    global $USER;

    // Получаем имя из формы (поле NAME)
    $userNameFromForm = isset($arFields["AUTHOR_NAME"]) ? $arFields["AUTHOR_NAME"] : "Не указано";

    // Определяем строку для макроса #AUTHOR#
    if ($USER->IsAuthorized()) {
        $userId = $USER->GetID();
        $userLogin = $USER->GetLogin();
        $userName = $USER->GetFullName() ?: $userLogin;

        $authorText = "Пользователь авторизован: {$userId} ({$userLogin}) {$userName}, данные из формы: {$userNameFromForm}";
    } else {
        $authorText = "Пользователь не авторизован, данные из формы: {$userNameFromForm}";
    }

    // Заменяем макрос #AUTHOR# в полях письма
    foreach ($arFields as $key => &$value) {
        if (is_string($value)) {
            $value = str_replace("#AUTHOR#", $authorText, $value);
        }
    }
    unset($value); // сбрасываем ссылку

    // Записываем в журнал событий
    AddMessage2Log("Замена данных в отсылаемом письме – " . $authorText, "feedback_author_replace");

    // Опционально: можно добавить в $arFields['AUTHOR'] для совместимости
    $arFields["AUTHOR"] = $authorText;
}
``` 

6. Проверка 
- Убедитесь, что почтовый сервер настроен на сохранение писем в /home/bitrix/mail (это обычно делается через Sendmail или настройки PHP). Перейдите на страницу /ex2/feedback/.
	- Не авторизованный пользователь:
		- Заполните форму: имя — Иван, email — test@example.com, сообщение — Тест.
		- Отправьте → проверьте письмо в /home/bitrix/mail — должно быть:
``` 
Автор: Пользователь не авторизован, данные из формы: Иван
``` 

	- Авторизованный пользователь:
		- Авторизуйтесь на сайте.
		- Заполните ту же форму.
		- Письмо должно содержать:
``` 
Автор: Пользователь авторизован: 1 (admin) Администратор, данные из формы: Иван
``` 

7. Проверьте журнал событий:
- Перейдите в Журнал событий (Настройки → Журнал событий).
- Фильтр по источнику: feedback_author_replace.
- Должна быть запись:

``` 
Замена данных в отсылаемом письме – Пользователь не авторизован, данные из формы: Иван
``` 

## Для решения задачи использовано следующее программное обеспечение: 
- Версия MySQL Community Server: 8.0.43.
- Версия PHP: 8.2.22.
- Версия web-сервера Apache: 2.4.20 (Win64).
- Версия "1С-Битрикс: Управление сайтом": 25.100.500.
		       





